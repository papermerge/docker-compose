# Docker Compose for Papermerge with Zitadel Cloud OIDC Authentication
#
# Architecture:
#   User -> OAuth2-Proxy (OIDC auth) -> Papermerge Core
#                  |
#              Zitadel Cloud (Identity Provider)
#
# Prerequisites:
#   1. Create an application in Zitadel Cloud (pm36dev instance)
#   2. Generate a cookie secret: openssl rand -base64 32
#   3. Copy .env.example to .env and configure all values
#
# Usage:
#   cd docker-zitadel
#   docker compose up -d
#
# Access:
#   - Papermerge: http://localhost:8080

services:
  # PostgreSQL 17 - for Papermerge
  postgres:
    image: postgres:17
    restart: unless-stopped
    environment:
      POSTGRES_USER: pm
      POSTGRES_PASSWORD: pm
      POSTGRES_DB: pmdb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U pm -d pmdb" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # OAuth2 Proxy - Handles OIDC authentication with Zitadel
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.7.1
    restart: unless-stopped
    command:
      - --http-address=0.0.0.0:4180
      - --upstream=http://papermerge:80
      # Use generic OIDC provider (not keycloak-oidc)
      - --provider=oidc
      - --provider-display-name=Zitadel
      # Zitadel Cloud configuration (set via environment variables)
      - --client-id=${ZITADEL_CLIENT_ID}
      - --client-secret=${ZITADEL_CLIENT_SECRET}
      - --oidc-issuer-url=${ZITADEL_ISSUER_URL}
      - --redirect-url=http://localhost:8080/oauth2/callback
      # Allow all email domains (adjust as needed)
      - --email-domain=*
      # Cookie configuration
      - --cookie-secret=${OAUTH2_COOKIE_SECRET}
      - --cookie-secure=false
      - --cookie-name=_oauth2_proxy
      # Skip provider selection button (go directly to Zitadel)
      - --skip-provider-button=true
      # Use 'sub' claim as user ID (Zitadel recommendation)
      - --user-id-claim=sub
      # Pass access token to upstream (Papermerge)
      - --pass-access-token=true
      - --set-authorization-header=true
      # Request necessary scopes
      - --scope=openid profile email
      # Whitelist domains for logout redirects
      - --whitelist-domain=localhost:8080
      - --whitelist-domain=${ZITADEL_DOMAIN}
    ports:
      - "8080:4180"
    depends_on:
      - papermerge
    environment:
      # These can also be set via command line args above
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_COOKIE_SECRET}

  # Papermerge - Document Management System (OIDC image)
  papermerge:
    image: papermerge/papermerge:3.6.0a6-oidc
    restart: unless-stopped
    environment:
      PM_DB_URL: postgresql://pm:pm@postgres:5432/pmdb
      # OIDC Logout Configuration for Zitadel
      # Zitadel's end_session_endpoint is at /oidc/v1/end_session
      PM_OIDC_LOGOUT_URL: ${ZITADEL_ISSUER_URL}/oidc/v1/end_session
      PM_POST_LOGOUT_REDIRECT_URI: http://localhost:8080
      PM_OIDC_CLIENT_ID: ${ZITADEL_CLIENT_ID}
    volumes:
      - papermerge_media:/app/media
      - ./log_config.yaml:/app/log_config.yaml
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
  papermerge_media:
